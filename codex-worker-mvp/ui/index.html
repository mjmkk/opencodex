<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Codex Worker MVP（核心流程）</title>
    <link rel="stylesheet" href="/ui/style.css" />
  </head>
  <body>
    <div class="app">
      <header class="topbar">
        <div class="brand">
          <div class="brand-title">Codex Worker MVP</div>
          <div class="brand-sub">对齐核心目标：Thread / Job / SSE / Approval 闭环</div>
        </div>
        <div class="conn">
          <label class="field">
            <span>Worker 地址</span>
            <input id="baseUrl" type="text" spellcheck="false" />
          </label>
          <label class="field">
            <span>Token（可选）</span>
            <input id="token" type="password" spellcheck="false" placeholder="WORKER_TOKEN（如启用）" />
          </label>
          <button id="refresh" class="btn">刷新</button>
        </div>
      </header>

      <main class="grid">
        <section class="panel">
          <h2>线程（Thread：会话线程）</h2>
          <div class="row">
            <button id="loadThreads" class="btn btn-ghost">拉取线程列表</button>
          </div>
          <div id="threads" class="list"></div>
          <div class="divider"></div>
          <h3>新建线程</h3>
          <div class="form">
            <label class="field">
              <span>项目目录（ProjectPath：工作目录）</span>
              <select id="projectPath"></select>
            </label>
            <label class="field">
              <span>线程名（可选）</span>
              <input id="threadName" type="text" placeholder="mvp" />
            </label>
            <label class="field">
              <span>审批策略（ApprovalPolicy：何时需要你确认）</span>
              <select id="threadApprovalPolicy">
                <option value="on-request">on-request（仅当服务端要求审批时才弹）</option>
                <option value="untrusted">untrusted（更严格，常用于强制走审批链路）</option>
                <option value="on-failure">on-failure（失败风险时才审）</option>
                <option value="never">never（不审批，危险）</option>
              </select>
            </label>
            <label class="field">
              <span>沙箱模式（Sandbox：运行权限范围）</span>
              <select id="sandbox">
                <option value="workspace-write">workspace-write（允许写工作区）</option>
                <option value="read-only">read-only（只读，更容易触发写入审批）</option>
                <option value="danger-full-access">danger-full-access（全权限，危险）</option>
              </select>
            </label>
            <button id="createThread" class="btn">创建线程</button>
          </div>
        </section>

        <section class="panel">
          <h2>对话与任务（Job：一次发消息触发的任务）</h2>
          <div class="row">
            <div class="kv">
              <div class="k">当前线程</div>
              <div id="activeThread" class="v mono">未选择</div>
            </div>
            <div class="kv">
              <div class="k">当前 Job</div>
              <div id="activeJob" class="v mono">无</div>
            </div>
            <div class="kv">
              <div class="k">状态</div>
              <div id="activeState" class="v badge">-</div>
            </div>
          </div>

          <div class="form">
            <label class="field">
              <span>本次审批策略（可选）</span>
              <select id="turnApprovalPolicy">
                <option value="">（不覆盖）</option>
                <option value="on-request">on-request</option>
                <option value="untrusted">untrusted</option>
                <option value="on-failure">on-failure</option>
                <option value="never">never</option>
              </select>
            </label>
            <label class="field">
              <span>输入</span>
              <textarea id="input" rows="4" placeholder="例如：请总结当前仓库的 README，然后等待审批时点击接受。"></textarea>
            </label>
            <label class="check">
              <input id="autoApprove" type="checkbox" />
              <span>自测模式：自动接受审批（用于验证闭环，不需要你点）</span>
            </label>
            <div class="row">
              <button id="send" class="btn">发送（turn/start）</button>
              <button id="cancel" class="btn btn-warn" disabled>取消任务（cancel）</button>
            </div>
          </div>

          <div class="divider"></div>
          <h3>事件流（SSE：服务端推送事件）</h3>
          <div class="row">
            <button id="clearLog" class="btn btn-ghost">清空</button>
            <div class="hint mono" id="cursorHint">cursor=-1</div>
          </div>
          <pre id="log" class="log"></pre>
        </section>
      </main>
    </div>

    <div id="approvalModal" class="modal hidden" role="dialog" aria-modal="true">
      <div class="modal-card">
        <div class="modal-title">需要审批（Approval）</div>
        <div class="modal-body">
          <div class="kv">
            <div class="k">类型</div>
            <div id="apprKind" class="v mono">-</div>
          </div>
          <div class="kv">
            <div class="k">命令</div>
            <div id="apprCmd" class="v mono">-</div>
          </div>
          <div class="kv">
            <div class="k">目录</div>
            <div id="apprCwd" class="v mono">-</div>
          </div>
          <div class="kv">
            <div class="k">原因</div>
            <div id="apprReason" class="v">-</div>
          </div>
          <div class="hint">
            这是 MVP 的核心闭环：出现审批 -> 点击决策 -> 任务继续/终止。
          </div>
        </div>
        <div class="modal-actions">
          <button id="apprAccept" class="btn">接受</button>
          <button id="apprAcceptSession" class="btn btn-ghost">会话内接受</button>
          <button id="apprDecline" class="btn btn-warn">拒绝</button>
          <button id="apprCancel" class="btn btn-warn">取消任务</button>
        </div>
      </div>
    </div>

    <script type="module" src="/ui/app.js"></script>
  </body>
</html>
